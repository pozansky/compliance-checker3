import os
import re
from typing import Dict, Any, List, Tuple
import warnings

# 关闭所有 LangChain 相关警告
warnings.filterwarnings("ignore", category=UserWarning)
warnings.filterwarnings("ignore", category=DeprecationWarning)

# 关闭 LangChain 控制台追踪
os.environ.setdefault("LANGCHAIN_TRACING_V2", "false")
os.environ.setdefault("LANGCHAIN_VERBOSE", "false")
# 关闭 LangChain 控制台追踪，避免打印检索结果等中间步骤

from langchain_community.vectorstores import FAISS
from langchain_huggingface import HuggingFaceEmbeddings
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnablePassthrough, RunnableLambda
from langchain_core.output_parsers import StrOutputParser
from langchain_core.documents import Document

# 设置 DashScope API Key

class ComplianceRAGEngine:
    def __init__(self):
        # 1. 初始化嵌入模型 (使用本地模型确保语义匹配精度)
        self.embeddings = HuggingFaceEmbeddings(
            model_name="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2"
        )
        
        # 2. 构建向量库（使用分块策略提高召回率）
        self._initialize_vector_store()

        # 3. 初始化 LLM (保持原有参数以确保确定性)
        self.llm = ChatOpenAI(
            model="deepseek-v3.2",
            openai_api_key=os.getenv("DASHSCOPE_API_KEY"), 
            openai_api_base="https://dashscope.aliyuncs.com/compatible-mode/v1",
            temperature=0.0,
            max_tokens=800,
            top_p=1.0,
            seed=42,
            max_retries=0,
        )

        # 4. 定义 RAG 专用 Prompt（完全保持原样）
        prompt = ChatPromptTemplate.from_template("""
你是一个【多规则违规事件判定器】。

你需要对【18 个独立违规事件】逐一进行“是否命中”的判断。
每一个事件【互不影响、互不推断、互不升级】。

━━━━━━━━━━━━━━━━━━
【全局执行原则（必须遵守）】

1. 每一个事件【单独判断】，禁止跨事件联想
2. 只能依据文本中【已经明确出现的内容】
3. 禁止任何主观推断、价值判断或监管精神延伸
4. 不允许因为“整体感觉违规”而命中某个事件

━━━━━━━━━━━━━━━━━━
【判定方式（统一适用于 18 个事件）】

对每一个事件，你只能问一个问题：

👉 文本中是否【直接出现】该事件规则中定义的行为？

- 如果“是”，该事件命中
- 如果“否”或“需要解释才能成立”，该事件不命中

━━━━━━━━━━━━━━━━━━
【违规规则详情（逐条独立使用，不得合并）】
{context}

━━━━━━━━━━━━━━━━━━
【强制约束】

- “诱导”“暗示”“鼓励”“评价”“建议”“风险说明”
  在任何事件中，若未被规则明确定义为违规，
  一律视为【不命中】

- 不允许创造规则中不存在的违规形式

━━━━━━━━━━━━━━━━━━
【输出规则（严格）】

你必须输出以下三行，不得附加任何内容：

是否违规：是 / 否
触发事件：命中的事件名称（多个用英文逗号分隔；若无填“无”）
理由：对每个命中事件，引用【原文中直接触发该事件的句子】

━━━━━━━━━━━━━━━━━━
【事件名称白名单（只能从中选择）】

直接承诺收益、
突出客户盈利反馈、
突出描述个股涨幅绩效、
对投研调研活动夸大宣传、
向客户索要手机号、
使用敏感词汇、
异常开户、
干扰风险测评独立性、
错误表述服务合同生效起始周期、
不文明用语、
以退款为营销卖点、
怂恿客户使用他人身份办理服务、
违规指导、
将具体股票策略接入权限作为即时办理卖点、
虚假宣传案例精选及人工推票、
冒用沈杨老师名义、
收受客户礼品、
夸大宣传策略重仓操作

━━━━━━━━━━━━━━━━━━
【待检测聊天内容】
{input}

━━━━━━━━━━━━━━━━━━
【最终指令】

请直接给出最终三行结果，不得输出任何分析或解释。

【再次强调（最终输出强制执行）】

你必须只输出三行，顺序、内容、措辞必须严格一致：
是否违规：
触发事件：
理由：

不得输出任何解释、分析、补充说明。
""")



        # 5. 检索配置：按规则召回完整规则，不 rerank
        self._retrieve_k = 20  # chunk 检索数量，用于得到候选规则 ID
        self._retrieve_score_threshold = 0.35
        self._max_rules = 6  # 最多送入 LLM 的规则条数（硬上限）
        self.retriever = self.vectorstore.as_retriever(search_kwargs={"k": self._retrieve_k})
        self.retriever_with_score = self.vectorstore.as_retriever(
            search_type="similarity_score_threshold",
            search_kwargs={"k": self._retrieve_k, "score_threshold": self._retrieve_score_threshold}
        )

        self.chain = (
            {"context": RunnableLambda(self._retrieve_rules_full) | RunnableLambda(self._format_docs), "input": RunnablePassthrough()}
            | prompt
            | self.llm
            | StrOutputParser()
        )

    def _format_docs(self, docs):
        """格式化检索到的文档"""
        return "\n\n---\n\n".join(doc.page_content for doc in docs)

    def _normalize_input_text(self, text: Any) -> str:
        """保证检索/预测入口拿到的是字符串，避免 dict/None 导致 TypeError。"""
        if text is None:
            return ""
        if isinstance(text, str):
            return text
        if isinstance(text, dict):
            return str(text.get("input", text.get("context", "")) or "")
        return str(text)

    def _get_candidate_rule_ids(self, text: str) -> List[int]:
        """用分块语义检索 + 关键词匹配得到候选规则 ID 列表（去重、保序）。"""
        text = self._normalize_input_text(text)
        seen: set = set()
        ordered: List[int] = []
        try:
            semantic_docs = self.retriever_with_score.invoke(text)
        except Exception:
            semantic_docs = self.retriever.invoke(text)
        for doc in semantic_docs:
            rid = doc.metadata.get("rule_id")
            if rid is not None and rid not in seen:
                seen.add(rid)
                ordered.append(rid)
        for rule_id, _score, _kw in self._keyword_match_rules(text):
            if rule_id not in seen:
                seen.add(rule_id)
                ordered.append(rule_id)
        return ordered

    def _retrieve_rules_full(self, text: str) -> List[Document]:
        """按规则召回：先得到候选规则 ID，再取每条规则的完整原文，按候选顺序取 top N 条（不做 rerank）。"""
        text = self._normalize_input_text(text)
        candidate_ids = self._get_candidate_rule_ids(text)
        candidates: List[Tuple[int, str]] = []
        for rid in candidate_ids:
            full_text = self._full_rules_by_id.get(rid)
            if full_text:
                candidates.append((rid, full_text))
        if not candidates:
            return []
        candidates = candidates[: self._max_rules]
        return [
            Document(
                page_content=full_text,
                metadata={"rule_id": rid, "rule_name": self._get_rule_name_by_id(rid)}
            )
            for rid, full_text in candidates
        ]

    def _retrieve_hybrid(self, text: str) -> List[Document]:
        """混合检索（分块）：仅用于调试对比；主流程已改为 _retrieve_rules_full。"""
        try:
            semantic_docs = self.retriever_with_score.invoke(text)
        except Exception:
            semantic_docs = self.retriever.invoke(text)
        seen_chunks = {(doc.metadata.get("rule_id"), doc.metadata.get("chunk_type", "")) for doc in semantic_docs}
        result = list(semantic_docs)
        for rule_id, _score, _kw in self._keyword_match_rules(text)[:5]:
            for doc in self._rule_id_to_docs.get(rule_id, []):
                key = (doc.metadata.get("rule_id"), doc.metadata.get("chunk_type", ""))
                if key not in seen_chunks:
                    seen_chunks.add(key)
                    result.append(doc)
        return result[:20] if len(result) > 20 else result

    def _initialize_vector_store(self):
        """将完整的18条规则分块存储到向量库，并保存每条规则的完整原文供按规则召回。"""
        full_rules = self._get_full_rules_content()
        # 按规则ID保存完整规则原文，用于「按规则召回」时返回整条规则，避免漏判
        self._full_rules_by_id: Dict[int, str] = {i + 1: full_rules[i] for i in range(len(full_rules))}

        documents = []
        for i, rule_text in enumerate(full_rules):
            rule_id = i + 1
            rule_name = self._get_rule_name_by_id(rule_id)
            chunks = self._split_rule_into_chunks(rule_text, rule_id, rule_name)
            documents.extend(chunks)

        self.vectorstore = FAISS.from_documents(documents, self.embeddings)
        self._rule_id_to_docs: Dict[int, List[Document]] = {}
        for doc in documents:
            rid = doc.metadata.get("rule_id")
            if rid is not None:
                self._rule_id_to_docs.setdefault(rid, []).append(doc)

        self._build_rule_keyword_index()

    # 规则正文滑动窗口：按「段」建索引，embedding 能命中任意违规点；送入 LLM 仍用 _full_rules_by_id 整条
    _chunk_size = 600
    _chunk_overlap = 200

    def _split_rule_into_chunks(self, rule_text: str, rule_id: int, rule_name: str) -> List[Document]:
        """将单条规则分割成多个小块：滑动窗口覆盖全文 + 语义段（标题/违规情形/排除条款等）。"""
        chunks = []
        size, overlap = self._chunk_size, self._chunk_overlap
        step = max(1, size - overlap)
        # 滑动窗口覆盖整条规则，便于检索命中任意一段（含后半段排除条款等）
        for i, start in enumerate(range(0, len(rule_text), step)):
            segment = rule_text[start : start + size]
            if not segment.strip():
                continue
            chunks.append(Document(
                page_content=f"【规则{rule_id}: {rule_name}】\n{segment}",
                metadata={"rule_id": rule_id, "rule_name": rule_name, "chunk_type": "window", "chunk_index": i}
            ))
        if not chunks:
            chunks.append(Document(
                page_content=f"【规则{rule_id}: {rule_name}】\n{rule_text}",
                metadata={"rule_id": rule_id, "rule_name": rule_name, "chunk_type": "window", "chunk_index": 0}
            ))

        # 语义段：标题、核心逻辑、违规情形、排除条款、重要说明
        # 1. 提取标题和核心逻辑
        title_match = re.search(r"### \d+\. (.*?)\n", rule_text)
        if title_match:
            title_part = title_match.group(1)
            chunks.append(Document(
                page_content=f"【规则{rule_id}标题】{title_part}",
                metadata={"rule_id": rule_id, "rule_name": rule_name, "chunk_type": "title"}
            ))
        
        # 2. 提取核心逻辑部分（如果有）
        core_logic_pattern = r"【核心逻辑】.*?(?=\n\n|$)"
        core_logic_match = re.search(core_logic_pattern, rule_text, re.DOTALL)
        if core_logic_match:
            core_logic = core_logic_match.group(0)
            chunks.append(Document(
                page_content=f"【规则{rule_id}核心逻辑】{core_logic}",
                metadata={"rule_id": rule_id, "rule_name": rule_name, "chunk_type": "core_logic"}
            ))
        
        # 3. 提取具体违规情形
        violation_pattern = r"具体违规情形.*?(?=绝对排除条款|重要说明|最终判断|$)"
        violation_match = re.search(violation_pattern, rule_text, re.DOTALL | re.IGNORECASE)
        if violation_match:
            violations = violation_match.group(0)
            chunks.append(Document(
                page_content=f"【规则{rule_id}违规情形】{violations}",
                metadata={"rule_id": rule_id, "rule_name": rule_name, "chunk_type": "violation"}
            ))
        
        # 4. 提取绝对排除条款
        exclusion_pattern = r"绝对排除条款.*?(?=\n\n|重要说明|最终判断|$)"
        exclusion_match = re.search(exclusion_pattern, rule_text, re.DOTALL | re.IGNORECASE)
        if exclusion_match:
            exclusions = exclusion_match.group(0)
            chunks.append(Document(
                page_content=f"【规则{rule_id}排除条款】{exclusions}",
                metadata={"rule_id": rule_id, "rule_name": rule_name, "chunk_type": "exclusion"}
            ))
        
        # 5. 提取重要说明
        note_pattern = r"重要说明.*?(?=\n\n|最终判断|$)"
        note_match = re.search(note_pattern, rule_text, re.DOTALL | re.IGNORECASE)
        if note_match:
            notes = note_match.group(0)
            chunks.append(Document(
                page_content=f"【规则{rule_id}重要说明】{notes}",
                metadata={"rule_id": rule_id, "rule_name": rule_name, "chunk_type": "note"}
            ))
        
        return chunks

    def _build_rule_keyword_index(self):
        """构建规则关键词索引"""
        self.rule_keywords = {}
        
        # 为每条规则定义关键词
        keyword_definitions = {
            1: ["保证", "承诺", "一定", "肯定", "绝对", "赚钱", "盈利", "收益", "获利", "包赔", "稳赚", "保本"],
            2: ["报喜", "赚了", "盈利", "翻倍", "涨停", "本金", "收益", "回血", "翻身", "持仓", "截图", "晒单"],
            3: ["大涨", "涨停", "连板", "狂飙", "暴涨", "涨幅", "牛股", "妖股", "战绩", "案例"],
            4: ["调研", "一手资料", "内幕", "知根底", "了如指掌", "机构", "持仓"],
            5: ["电话", "手机号"],
            6: ["抓涨停", "翻倍", "回血", "回本", "暴涨", "吃肉", "捡钱", "稳赚", "本金无忧"],
            7: ["开户", "券商", "佣金", "最低", "诱导", "加微信"],
            8: ["风险测评", "选C", "选最高", "填高", "教唆", "修改", "别选", "错误选项"],
            9: ["合同", "生效", "起始", "下周", "明天", "推迟", "日期"],
            10: ["傻逼", "脑残", "穷鬼", "垃圾", "废物", "白痴", "蠢货", "骂人"],
            11: ["退款", "退费", "退钱", "不满意退", "随时退", "全额退", "无理由退"],
            12: ["他人身份", "家人身份", "朋友身份", "借身份", "用别人"],
            13: ["买入", "卖出", "持有", "减仓", "清仓", "止损", "做T", "调仓", "压力位"],
            14: ["对标", "复制", "一样", "走势", "涨停", "翻倍", "涨幅", "目标", "历史"],
            15: ["明日", "尾盘", "建仓", "跟上", "代码", "买卖区间", "锁定", "名额"],
            16: ["沈杨老师", "沈老师", "亲选", "亲自", "亲自给票", "亲自带队", "亲自通知", "亲自推送", "亲自陪伴"],
            17: ["礼物", "红包", "赠送", "收受", "寄给您", "一点心意", "寄个东西", "给您带点", "寄点特产", "一点小意思", "请我吃饭", "到你的城市玩", "你请客"],
            18: ["重仓", "小打小闹", "开仓", "机构重仓", "重仓参与", "上仓位", "重仓操作", "机构重仓股", "重仓王股", "调研复核", "带客户重仓"]
        }
        
        for rule_id, keywords in keyword_definitions.items():
            self.rule_keywords[rule_id] = keywords

    def _get_rule_name_by_id(self, rule_id: int) -> str:
        """根据规则ID获取规则名称"""
        rule_names = {
            1: "直接承诺收益",
            2: "突出客户盈利反馈", 
            3: "突出描述个股涨幅绩效",
            4: "对投研调研活动夸大宣传",
            5: "向客户索要手机号",
            6: "使用敏感词汇",
            7: "异常开户",
            8: "干扰风险测评独立性",
            9: "错误表述服务合同生效起始周期",
            10: "不文明用语",
            11: "以退款为营销卖点",
            12: "怂恿客户使用他人身份办理服务",
            13: "违规指导",
            14: "将具体股票策略接入权限作为即时办理卖点",
            15: "虚假宣传案例精选及人工推票",
            16: "冒用沈杨老师名义",
            17: "收受客户礼品",
            18: "夸大宣传策略重仓操作",
        }
        return rule_names.get(rule_id, f"规则{rule_id}")

    def _get_full_rules_content(self) -> List[str]:
        """返回完整的1条规则内容"""
        # 这里返回您提供的完整16条规则
        # 由于代码长度限制，我只展示前2条完整的规则，您需要将16条完整规则都放进来
        return [
            """### 1. 直接承诺投资收益

【事件定义】
本事件仅判断：是否存在由服务方作出的、对客户未来投资金钱收益结果的确定性保证。

【最高优先级判定流程（必须严格执行）】

【步骤一：句子隔离】
- 必须将文本按：句号、问号、感叹号、换行符，切分为独立短句。
- 后续所有判断【仅限单句内完成】，严禁跨句组合、联想或因果推理。

【步骤二：保证类词语扫描】
- 仅当短句中出现以下词语之一时，才进入“保证判断”：
  “保证”“承诺”“保”“一定”“肯定”“绝对”

【步骤三：保证指向判定】
- 若“保证/承诺”等词语，指向的是以下内容之一：
  服务内容、服务标准、产品一致性、价格、费用、续费、流程、交付、发票、合同、响应速度、真实性说明  
  → 该句判定为【服务保证】，直接认定【合规】，不得继续分析。

- 若“保证/承诺”等词语，直接或间接指向：
  赚钱、盈利、获利、收益、回报、涨幅、点位、翻倍等金钱投资结果  
  → 标记为【候选违规句】，进入“三要素”验证。

【三要素最终违规判定（必须同时满足）】
仅当以下三个条件【全部成立】，才可判定违规：
1. 主语明确为服务方（如“我”“我们”“老师”“机构”）
2. 语气为确定性承诺（非问句、非假设、非反问）
3. 内容为对客户未来投资收益的直接、具体保证

【强制豁免条款（命中即合规，不得再解释）】

以下情形一律判定为【合规】：
- 商业模式或续费逻辑说明（如“你赚钱了才会续费”“我们赚的是续费钱”）
- 双赢目标或愿景表达（如“我们比你更希望你赚钱”）
- 带问号的互动、挑战、邀约话术（如“赚20%送个锦旗好吗？”）
- 历史战绩展示，不与任何保证性语句合并解读
- 否定式、反讽式表达（如“我保证你赚钱那我不成骗子了？”）
- 对服务一致性、真实性、价格、费用、交付的任何保证
- 情绪性祝愿、期待、安慰性表达（如“争取早点报喜”“赚100块嘛”）

【禁止推理规则（必须遵守）】
- 禁止将“历史表现”推导为“未来收益保证”
- 禁止将“服务保证”脑补为“收益保证”
- 禁止将多个合规短句组合推理为违规结论

【字面匹配死线原则】
- 若未出现“确定性承诺词 + 明确金钱收益结果”的同句结构，
  一律判定为【合规】。""",

"""### 2. 突出客户盈利反馈

【事件定义】
本事件仅判断：是否通过展示或引用客户/第三方案例，来证明或暗示客户获得了具体投资收益结果，从而进行“晒单/案例营销”。

【最高优先级判定流程（必须严格执行）】

【步骤一：句子隔离】
- 必须将文本按：句号、问号、感叹号、换行符，切分为独立短句。
- 所有判断【仅限单句或同一明确案例内完成】，严禁跨句拼接或脑补因果关系。

【步骤二：是否为“客户/第三方案例”】
- 仅当文本明确指向以下主体之一时，才进入本规则判断：
  客户、学员、粉丝、老用户、案例、他人、转介绍对象、群内成员
- 若仅为客观行情、市场描述、非特定对象陈述 → 不适用本规则。

【步骤三：收益信息扫描（核心判定）】
仅当案例中出现以下内容之一，才可进入违规判断：
- 明确的金钱数额（如：赚了X万、盈利X元）
- 明确的比例或倍数（如：涨了X%、翻倍）
- 明确的每股收益（如：一股赚X元）
- 明确的账户资产显著变化（如：账户翻身、资产翻倍）

【直接违规情形（命中任意一条即违规）】

1. 【本金 + 收益】同时出现  
   - 如：“10万本金赚20万”“14万一周赚7万5”

2. 【时间 + 收益】同时出现  
   - 如：“3天赚50%”“一周盈利10万”

3. 【个股 + 涨幅比例】用于案例展示  
   - 如：“航天发展50%、方正电机20%、海南发展50%”
   - 该情形视为利用历史战绩进行案例营销，直接违规

4. 带有具体数字的客户盈利报喜  
   - 如：“学员赚了3万多”“一股赚了11块多”“拿到8000块彩头”

5. 明确的账户规模跃迁描述  
   - 如：“账户从亏损到翻身”“资金上千万的大佬也发来持仓说赚很多”

6. 极端胜率或绝对化结果  
   - 如：“客户买的票全部涨停”“从未亏损”

【强制合规豁免条款（命中即合规，不得继续分析）】

以下情形一律判定为【合规】：

1. 模糊报喜、情绪性反馈、满意度表达  
   - 仅出现“报喜了”“收获多”“太好了”“连续报喜”
   - 且【未出现任何具体金额、比例或每股收益】

2. 服务价值或专业能力认可  
   - 如：“服务费花得值”“实力确实给力”“点位很准”
   - 或“避免了更大亏损”的避险表述

3. 起始本金或合作门槛说明  
   - 仅提及“2000资金”“3000本金”“198元服务费”
   - 且未展示后续赚了多少钱

4. 纯行情或市场客观描述（非案例）  
   - 如：“这只票涨了50%”“景旺电子3天3板”
   - 未绑定具体客户或学员收益

【禁止推理规则（必须遵守）】
- 禁止将“报喜次数多”推导为“赚得多”
- 禁止将“小资金参与”推导为“高收益”
- 禁止将“行情涨幅”自动脑补为“客户盈利”
- 禁止将多个合规短句组合推理为违规结论

【语音转文本特别指令】
- 若文本中虽表述模糊，但语音转文本明确出现具体盈利数字，
  必须按【出现数字】处理，判定为违规。

【字面匹配死线原则】
- 若未出现“具体盈利数字 / 比例 / 每股收益 / 账户规模跃迁”，
  即便存在“报喜”“收获多”“状态很好”等表述，
  一律判定为【合规】。
""",
            
            """### 3. 突出描述个股涨幅绩效

【事件定义】
本事件仅判断：是否在缺乏产品、工具、策略或服务语境支撑的情况下，
对个股涨幅结果进行炫耀式、批量式展示，从而制造“买了就赚”的绩效暗示。

【最高优先级判定流程（必须严格执行）】

【步骤一：句子与股票隔离】
- 必须将文本按：句号、问号、感叹号、换行符，切分为独立短句。
- 判断时需明确：是否在同一段落/同一语境中集中描述多个个股的涨幅表现。
- 严禁跨段落、跨语境拼接推理。

【步骤二：是否存在产品/工具/策略语境（最高优先级）】
- 若文本中明确提及以下任一要素：
  产品、工具、模型、策略、战法、课程、实战班、APP推送、服务记录、老师方法论
  → 直接判定为【合规】，不得再进入违规分析。

【步骤三：是否存在选股逻辑说明】
- 若文本中出现任何选股依据或逻辑说明，包括但不限于：
  资金、主线、低位、突破、共振、量能、结构、趋势、战法名称
  → 视为“有逻辑描述”，判定为【合规】。

【直接违规情形（仅在步骤二、三均未命中时才可适用）】

1. 【裸描述个股涨幅】
   - 仅描述个股上涨结果或情绪性形容词
   - 未提及任何工具、策略、服务或选股逻辑
   - 如：“XX再次大涨”“一路狂飘”“太牛了好票提前分享”

2. 【批量罗列个股涨幅（3只及以上）】
   - 在无服务、无工具、无逻辑背景下
   - 集中列举3只或3只以上个股的涨幅、涨停或连板情况
   - 如：“A涨停，B涨50%，C涨40%”

3. 【高诱导性连续上涨词汇（无分析）】
   - 使用“连板”“连阳”“连续涨停”等强刺激词汇
   - 且未给出任何分析或逻辑说明
   - 如：“已经5连板了”“连续收获3个涨停板”

【强制合规豁免条款（命中即合规，不得继续分析）】

以下情形一律判定为【合规】：

1. 产品 / 工具 / 策略能力验证
   - 明确用于展示模型、工具、策略或服务推送记录的有效性
   - 如：“黄金杯模型案例——中电港入选后涨超20%”
   - 如：“实战班主力共振策略，利群股份再次涨停”

2. 包含任何形式的选股逻辑或战法说明
   - 无论逻辑是否专业、是否详细
   - 只要回答了“为什么选这只票”，即视为合规

3. 对老师或服务能力的评价与反馈
   - 如：“老师实力反复验证”“服务确实靠谱”

4. 仅出现股票代码或名称
   - 未描述涨幅结果
   - 如：“关注以下三只票：000001、000002、000003”

【禁止推理规则（必须遵守）】
- 禁止将“展示策略有效性”推理为“绩效炫耀”
- 禁止将“单只或少量个股上涨”推理为“买了全赚”
- 禁止将“行情事实”自动脑补为“营销诱导”
- 禁止跨语境拼接多个合规描述形成违规结论

【数量死线原则】
- 在【无产品 / 无工具 / 无策略 / 无逻辑】的前提下：
  - 描述 3 只及以上个股涨幅 → 可判定违规
  - 描述少于 3 只个股 → 一律判定为【合规】

  【边界锚定说明】
- 若文本核心在于展示“客户/学员/他人”的盈利结果 → 优先适用【第2条】
- 若文本核心在于展示“个股涨幅本身”，且未明确指向具体客户盈利 → 优先适用【第3条】
- 严禁同一句话同时触发第2条与第3条

【最终死线原则】
- 只要文本中出现产品、工具、策略或选股逻辑之一，
  即便出现涨幅、涨停、连板等描述，
  一律判定为【合规】。
""",
            
            """### 4. 对投研调研活动夸大宣传视为违规！！
注意，只有员工明确强调线下调研后能获取一手资料、知根底、了如指掌，或明确强调联合调研了解机构真实持仓情况且股价受调研影响时才视为违规。""",
            
   """### ## 5. 向客户索要手机号

### 【核心判定原则】
仅当客服**明确、直接要求客户将手机号提供给客服本人**时，才判定为违规。  
除明确索要外，任何说明、解释、提醒、确认或流程引导行为，均不得判定为违规。

---

### 【唯一违规情形】
客服主动向客户索取手机号内容，且目的在于获取该号码本身。

**违规判定必须同时满足以下条件：**
- 出现明确的索取指令（如：报我、给我、发我、留一个、提供）
- 索取对象为手机号或电话号码
- 号码将被提供给客服（而非在系统中由客户自行完成验证）

**典型违规话术包括但不限于：**
- “你手机号报我一个”
- “把你微信绑定的手机号发我一下”
- “留个手机号我登记”

---

### 【明确不构成违规的情形（强制排除，禁止误判）】

以下情形一律不视为“索要手机号”：

#### 1. 回访或系统机制说明
仅说明回访电话、系统、AI、账号绑定所使用的手机号规则。
- 示例：“回访打的是你当时绑定的手机号”

#### 2. 接听电话时间或便利性确认
询问或提醒接电话时间、来电号段、是否需要回拨。
- 示例：“你什么时候接电话方便”

#### 3. 客户主动提供或提出手机号安排
客户主动提供手机号或提出回拨方案，客服仅作确认或解释。
- 客服未主动索要手机号的，不构成违规

#### 4. 开户 / 实名 / 验证流程说明（重点排除）
仅说明客户**使用本人手机号在系统页面完成验证**的操作方式，不涉及将号码提供给客服。

判定要点：
- 表述指向系统侧验证行为，而非客服获取号码本身
- 即便出现“点击 / 选择 / 确认 / 提交你自己的手机号”等页面操作指引，只要未要求将号码提供给客服，一律不违规

**不违规示例：**
- “用你手机号收验证码完成实名”
- “在开户页面选择你自己的手机号进行验证”

---

### 【强制判定规则】
- 未出现客服向客户索取手机号内容的，不得判定为违规
- 涉及“回访”“系统自动拨打”“绑定手机号”“验证码验证”等表述，默认视为业务说明
- 仅对客服**获取手机号信息本身**的明确行为进行违规判定

---

### 【判定总结】
向客服提供手机号本身属于索要手机号，构成违规；  
在系统中使用本人手机号完成任何验证、确认或回访相关操作，均不构成违规。
""",
 
            """### 6. 使用敏感词汇

### 【核心判定逻辑（两步制，严格执行）】
判定必须分为两步，**严禁跳步**：

1. **是否命中敏感词（字面/结构匹配）**
2. **是否构成对个股未来结果的承诺（语境定性）**

若**第一步未命中** → **直接判定合规，不得进入第二步**。

---

### 【第一步：敏感词命中判定（门槛规则）】

#### 判定规则
- 扫描文本是否命中下方“敏感词汇列表”
- 判定时**忽略标点、空格、分号等插入字符**
- 未命中任一敏感词 → **直接合规**

#### 命中规则分类

**E类（最高优先级｜防拆词规避）**
- 敏感词被标点、空格拆开，需先清洗再比对
- 等价即视为命中  
示例：`改 变 账；户` ≡ `改变账户`

**A类（固定短语，必须完整连续）**
- 必须字面完整出现，少字 / 多字均不匹配  
特殊说明：
- `吃肉行情` ≠ `吃肉`
- `牛股` ≠ `牛` / `太牛了`
- `进场买票 / 跟上买票` 中仅出现 `买票` → 不匹配

**B类（紧凑组合模式）**
- 允许 0–3 个字插入的动宾结构  
如：抓*涨停、抓*板
- **仅限个股**，指数/大盘描述不命中

**C类（词根匹配）**
- 标记为【词根】的词，包含即命中  
如：翻倍、回本、回血

**D类（白名单，强制不命中，最高权重）**
以下内容无论语气多强烈，只要未组成 A/B 类死线结构，一律视为**未命中**：
- 单词类：涨停、涨幅、大涨、赚钱、盈利、必买、必跟、买票（单独）
- 技术术语：涨停因子、主升浪、突破、反包、量价齐升、量化选股器
- 大盘/指数预测：指数X连阳、A股/大盘将上涨X%
- 营销语气：后悔、错过不再、真的看好、信我一次

---

### 【第二步：语境定性（仅在命中后执行）】

#### 判定为违规（未来结果承诺）
满足以下任一即违规：
- 对**当前推荐个股**做出**未来**结果的确定性描述
- 数字化、绝对化收益保证

违规示例：
- “加入我们，带你抓到一个涨停”
- “明天这只票翻倍”

#### 判定为合规（强制豁免）
以下情形一律合规：
- **历史事实**：已经涨停、昨天抓到
- **外部观点引用**：第三方机构对大盘 / 指数的预测（含百分比）
- **类比参考**：敏感词指向过去股票或指数
- **技术空间描述**：如“有7个点空间”
- **日常服务沟通**：买票吗、打算操作吗

---

### 【敏感词汇列表】

**1. 紧凑组合模式（0–3字间隔）**
- 抓*涨停、抓*板、*天*板

**2. 词根匹配**
- 预期收益【词根】、翻身【词根】、回血【词根】、回本【词根】
- 翻倍【词根】、翻番【词根】、暴涨【词根】

**3. 固定短语（需完整连续）**
- 预期空间、进场买票、跟上买票、上车买票、安排做票
- 吃肉行情、捡钱行情、成功率*%、收益率*%、胜率*%
- 连续*个涨停、*字板、牛股、妖股
- 改变账户、稳赚不赔、本金无忧、持续盈利、钱生钱
- 赚回服务费、抓10倍股、单车变摩托、翻身机会、游资机构抱团股、抱团股

---

### 【终极排除条款（最后防线）】
满足以下任一，**无条件判定合规**：
1. 已发生的事实或战绩
2. 大盘 / 指数描述（含未来预测）
3. 常规技术术语或指标说明
4. 强烈推荐或营销语气但无结果承诺
5. 日常服务与陪伴式对话

""",
            
            """### 7. 异常开户
注意，只有特定券商名称结合最低佣金/佣金优惠及加微信等诱导开户行为才视为违规。""",
            

"""###8. 干扰风险测评独立性

### 【核心判定逻辑】
**只有在以下情形之一出现时，才判定为违规：**
- 明确告诉客户**具体选哪个选项或不要选哪个选项**
- 为了通过测评，**教唆客户修改答案或填写不符合实际的内容**
- **教唆伪造核心身份信息**（姓名、身份证号）

除上述情形外，一律不得判定为违规。

---

### 【最高优先级豁免（判定前必须先执行）】
以下行为的目的在于**保证测评真实性、完成流程或进行风险教育**，一律视为【合规】，不得继续向下判违规：

#### 1. 流程提醒与操作协助（强制合规）
包括但不限于：
- “注意看题”“重新测评时仔细一点”
- “有两个题目要注意一下（未指定选项）”
- “显示重新测评了吗”“操作到最后截图给我”
- 为客户读题、解释题目字面意思
- 指导页面操作（缩小窗口、点下一步等）
- 支付/进度确认：“付好了跟我说一下”“签完到这个页面告诉我”

**只要未指定具体答案，一律合规。**

---

#### 2. 风险教育与常识引导（重点防误判）
向客户说明投资的客观现实与门槛，属于**合法风险提示**，一律合规，包括：
- “股市有波动，哪怕1%的波动也是风险”
- “如果一点风险都不能承受，是没法做投资的”
- “不具备风险承受能力，无法合作/无法开户”
- 基于常识的逻辑引导，如：
  - “既然进股市，就要具备基本风险认知”
  - “不能承受波动，是不可能在市场成功的”

**严禁将上述内容判定为施压或诱导。**

---

#### 3. 非指向性建议与非核心信息容错
以下话术默认属于口语化流程引导，一律合规：
- “根据实际情况填写”
- “只要不空着就行”
- 针对**非关键字段**（如地址、职业）：
  - “随便选一个”
  - “选哪个都行”
  - “没有固定答案”

**重要区分：**
- 若涉及【姓名、身份证号】并引导造假 → **违规**
- 若涉及【地址、职业】并引导不留白 → **合规**

---

#### 4. 进度与结果确认
仅确认是否完成流程或生成结果：
- “测评做完了吗”
- “出分了吗”
- “付了198跟我说一下，我去安排服务”

**只要未指定答案，一律合规。**

---

### 【明确违规情形（唯一红线）】
出现以下任一情形，即判定为违规：

- **指定选项**：
  - “这一题你选C才能过”
  - “年收入那栏选最高那个”
- **否定式指令**：
  - “这个选项不要选”
  - “这一项不符合目标，别点”
- **为了通过测评而教唆修改答案**：
  - “风险承受能力填高一点，不然买不了”
  - “改成激进型才能通过”
- **教唆伪造核心身份信息**：
  - “身份证号码随便填一个”
  - “名字随便写”
- **监控式陪同施压**：
  - “我带着你做，选一个告诉我一个”
  - “你每题选了什么跟我说一下”

---

### 【结论性判断原则（必须遵守）】
- **是否指向具体选项，是唯一违规判断标准**
- 风险教育 ≠ 诱导作答
- 引用开户经验 ≠ 指定答案
- 流程推进 / 支付确认 ≠ 干扰测评
- 未出现“选哪个 / 不选哪个 / 改成什么”的，一律判定为【合规】
""",
            
            
"""### 9. 错误表述服务合同生效起始周期

### 【核心判定逻辑】
**只有在以下情形出现时，才判定为违规：**

> 将客户**已付费购买的合同服务期起始日**，  
> **错误表述为晚于实际付款/办理日期的某个未来时间点**，  
> 从而**压缩客户实际应享有的服务时长**。

除上述情形外，一律不得判定为违规。

---

### 【明确违规情形（唯一红线）】
以下表述只要出现，直接判定为【违规】：

- “您买的半年服务，**合同期从下周开始算**”
- “虽然今天付款，**服务期明天才开始**”
- “合同写半年，**但时间从周一开始算**”
- “**下周一开始算时间**”（付款在今天）
- **任何明确指定合同/服务期起始日，且该日期晚于客户实际付款日的说法**

**判定要点：**
- 主体是 **合同期 / 服务期**
- 起始时间被**明确推迟到未来**
- 推迟对象是**客户已付费购买的服务周期**

---

### 【最高优先级豁免（判定前必须先执行）】
以下情形一律视为【合规】，不得继续向下判违规：

#### 1. 标准合同规则说明
- “合同从付款当天开始生效”
- “服务期按您今天办理的时间计算”

---

#### 2. 明确的额外赠送服务期
只要清楚区分**合同期**与**赠送期**，一律合规：
- “合同是半年，**我额外送您一个月**”
- “合同显示183天，**实际给您加到13个月**”
- “赠送的时间我会在线下给您加上”

**赠送期 ≠ 合同期，不构成违规。**

---

#### 3. 功能 / 策略 / 数据时间说明（重点防误判）
以下内容只涉及**产品使用或推送时间**，不涉及合同生效，一律合规：
- “明天早上10点会推送策略”
- “下周软件功能更新”
- “明天可以开始体验某个模块”

**判定原则：**
- 说“策略 / 功能 / 数据” → 合规  
- 说“合同 / 服务期” → 才进入违规判断

---

#### 4. 活动与优惠期限说明
强调营销稀缺性或优惠截止时间，一律合规：
- “活动今晚12点结束”
- “明天就没有13个月的优惠了”
- “这个赠送只到今天”

---

### 【最终判断原则（必须遵守）】
- **是否推迟“已付费合同期起始日”是唯一违规标准**
- 赠送期 ≠ 合同期
- 策略/功能时间 ≠ 合同期
- 优惠截止 ≠ 合同期
- 未明确提及合同起始日，或起始日为付款当日 → 一律合规
""",
            
            """### 10. 不文明用语
注意，只有使用具有侮辱、讽刺、歧视或攻击性内容的语言时才视为违规。

**具体违规情形：**
- 使用侮辱性词汇（如"傻逼"、"脑残"、"穷鬼"等）
- 对客户进行人身攻击或讽刺性嘲笑
- 使用粗俗语、骂人词汇、带有明显贬义的称呼
- 其他具有攻击性、歧视性的语言

**重要说明：**
- 营销话术、邀约表述不视为不文明用语
- 强调性表述（如"务必要重视"）属于正常沟通，不视为违规
- 情感表达（如"信心十足"）属于正常业务沟通，不视为违规
- 只有明确出现侮辱、攻击、歧视性内容才构成违规
- "骗子"以及相关词汇不视为不文明用语""",
            
            """#### 11. 以退款为营销卖点（违规）

【核心定义】
仅当**服务方在营销/邀约过程中，主动将“退款/退费/退钱”作为吸引客户成交的卖点或承诺**时，才构成违规。

【核心判定原则】
- **主动性**：必须是服务方主动提出，而非客户追问后的被动说明
- **营销性**：目的是促成交易、降低决策成本
- **对象性**：重点区分【定金】与【正式服务费/尾款】

---

【强制判定流程（必须按顺序执行）】

**第一步｜识别资金对象**
- 若话术明确指向 **定金 / 订金 / 诚意金**，且退款范围 **仅限该笔定金**
  → **直接判定为合规**（不再进入后续判断）

**第二步｜检查正式合同退款具体化**
- 若话术涉及 **正式服务费 / 尾款 / 合同**
- 且 **主动提及具体退款天数或明确条件**
  （如“3天/5天无理由”“不满意就退”）
  → **直接判定为违规**

**第三步｜判断是否作为营销卖点**
- 在推广、邀约、成交引导中
- 主动强调正式服务可退费、退全款、兜底保障
  → **判定为违规**

**第四步｜排除客户服务场景**
- 若属于售后、流程确认、协议处理
- 且仅模糊提及退款（不含天数、不作承诺）
  → **一律不违规**

---

【明确违规示例（营销场景下主动承诺）】
- “购买后不满意随时退款”
- “效果不好全额退费”
- “不赚钱就退钱”
- “达不到预期可以退”
- “合同写的是5天无理由退款”（主动告知具体天数）
- “放心办，不好用给你退”（暗示正式服务可退）

---

【绝对合规内容（不视为违规）】

**一、定金豁免（始终合规）**
- “先交定金体验，不满意定金全退”
- “定金15天自动原路退回”
- “聊几天再决定，补不补尾款都行，定金可退”

**二、被动或模糊说明**
- “有合同保障”
- “退款条款在合同里”
- “可以查看合同约定”
（⚠ 不得主动说具体天数）

**三、非营销性质沟通**
- 售后退款流程说明
- 退款协议签署确认
- 已发生退款的处理沟通

---

【关键补充规则】
- 客户问“几天能退？”
  - 回答“合同里有写” → 合规
  - 回答“合同是5天无理由退” → 违规
- “我为你负责到底”不等于退款承诺 → 合规
- 保证最低价 → 合规

【终极判断一句话】
**只有“为了成交而主动承诺正式服务可退款”，才是违规。**
""",
            
            """### 12. 怂恿使用他人身份办理服务（违规）

【核心定义】
仅当**话术中“字面明确引导客户使用第三方（非本人）身份办理服务”**时，才构成违规。

---

【强制判定原则（必须严格执行）】

**唯一判定标准：字面是否明确出现**
- 是否**直接、明确**出现“使用他人身份/他人名义”的表述
- **不允许任何上下文推断、语义联想、动机分析**

---

【明确违规（必须字面命中，完全匹配或等价表述）】
以下情况 **只要出现，即直接判定为违规**：

- “可以用家人的身份办理”
- “找朋友借身份来开户”
- “用别人的名义购买/办理服务”
- 明确指导或提供**他人身份信息**用于办理
- 任何**直接引导使用第三方身份**的表述

---

【绝对禁止的判定行为（模型必须遵守）】
- 禁止结合上下文进行扩展理解
- 禁止判断“是否存在暗示”
- 禁止将**名额限制**解读为身份问题
- 禁止将**回复指引**解读为身份问题
- 禁止将**营销话术**联想为身份违规
- 禁止主观推断客户或服务方意图

---

【绝对合规（以下一律不违规）】

**一、回复或操作指引**
- “回复【888】”
- “私信回1”
- “填写信息即可”

**二、名额 / 营销 / 服务描述**
- “名额有限 / 名额不多”
- “抢占优惠 / 申请最低价”
- “小资金帮扶”
- 任何未提及身份的营销话术

**三、未构成引导的身份提及**
- 单独出现身份材料名称（如：“这是XX的身份证”）
- 无“使用/借用/代办”指向的描述

---

【终极判定规则（不可覆盖）】
- **只有字面明确出现“使用他人身份办理服务”才违规**
- **未出现 → 一律合规**
- **禁止任何形式的推断、联想、补充理解**
""",
            


"""### 13. 违规指导视为违规！！

注意：**严禁员工以个人名义**向客户提供任何诊股或操作建议。  
**只有明确引用投顾老师 / 官方策略 / APP 指标 / 软件结果的观点，才视为合规。**  
员工个人的技术面判断（趋势、压力位、支撑位等）= 违规指导。

---

## 【最高优先级豁免：三张金牌】
**判定第一步：命中任意一张金牌，直接判定【合规】，不再继续判断。**

### 金牌 A：标准化投顾交付
**判定条件：**
- 同时出现 **投资顾问执业编号**（如 A024…）
- 且包含 **风险提示 / 免责声明**

→ 直接【合规】

---

### 金牌 B：引用他方观点 / 角色转接 / 服务中转
**判定条件：**
文本明确表明**观点或操作建议并非员工个人判断**，而是来源于老师 / 软件 / 官方策略，或仅为客服服务行为。

**典型合规表达：**
1. **引用来源**
   - “XX老师说 / 建议”
   - “软件 / 指标 / 魔方 / 检测网显示”
   - “根据策略显示的买卖区间 / 调入区间”

2. **角色转接（核心豁免）**
   - “具体操作由老师 / 助教负责”
   - “我只是助理 / 客服，水平没老师高”
   - “等下老师教你怎么做”

3. **服务中转 / 承诺**
   - “我帮你看 / 帮你盯 / 帮你提交给老师”
   - “买了跟我说，我帮你安排”
   - “教你怎么看软件里的操作提示”

4. **客观风险描述**
   - “老师主要帮你规避风险 / 提示止盈止损”
   - “模型预测大盘风险 / 优选强势股”

→ 直接【合规】

---

### 金牌 C：产品功能 / 教学 / 流程指引
**判定条件：**
仅在介绍产品功能、策略原理、软件使用方法或业务流程。

**典型合规表达：**
- “点击某模块查看分析”
- “这是策略逻辑示例，不是具体操作指令”
- “内部服务由老师通知买卖区间”
- 合同、对公账户、风险测评、实名认证、添加微信等流程说明

→ 直接【合规】

---

## 【次级合规场景（未命中金牌时）】
以下情形**不视为违规**：

1. **营销与风险提示**
   - “小资金试试 / 不追高 / 建议观望”
   - “高位风险大 / 仓位控制”

2. **战绩或案例展示**
   - 展示历史收益、软件截图、过往案例

3. **情绪安抚与心态引导**
   - “别着急 / 放平心态 / 相信专业”
   - 目的为稳定情绪并引导找老师

→ 均为【合规】

---

## 【违规判定核心标准】
**仅当所有豁免均未命中，且出现以下情况，才判定违规：**

### 情形一：员工个人直接下达交易指令
**关键词：**
买入、卖出、持有、拿住、减仓、清仓、止损、回本出、做T、换股、调仓

**违规示例：**
- “我觉得这个票你先拿住”
- “我建议你明天回本就走”

（无老师 / 软件 / 官方来源背书）

---

### 情形二：员工个人技术面诊股
**判定核心：**
员工撇开老师或软件，**以个人口吻**对走势做判断。

**违规关键词：**
下行趋势、压力位、支撑位、没止跌、资金合力、主力、该调了

**违规示例：**
- “这个票资金合力不行”
- “现在是下行趋势，还没止跌”

---

## 【明确不违规的排除项】
- “我帮你看 / 帮你盯 / 帮你提交给老师”（无具体分析）
- “我看了一下，软件 / 指标显示……”
- 泛化建议用于引导使用产品或找老师，而非直接下令

---

## 【最终判断逻辑（强制执行）】
1. **先看是否有老师 / 软件 / 指标 / 角色免责 / 服务中转**  
   → 有即【合规】
2. **再看是否只是功能教学或流程说明**  
   → 是即【合规】
3. **只抓纯私货**  
   - 员工个人口吻
   - 明确买卖 / 趋势判断
   - 无任何来源背书  
   → 才判【违规】 """,



            """###14. 将“具体股票策略操作权限作为即时办理卖点

**违规定义**
在营销中，**将客户付费与某一具体股票或策略的“单次/当下操作权限”直接绑定**，视为违规。

---

#### 最高优先级判定原则：诱饵与落脚点
**先看“落脚点”（最终引导动作）**  
- 若使用热点/信号/机会作为**诱饵**，但最终引导为**解锁服务/享受服务/开通权限/办理班级** → **合规**  
- 若最终引导为**为这一次具体操作付费** → **违规**

**判定口诀**
- “付钱，买这只票的操作权” → **违规**（单次售卖）  
- “付钱，解锁包含这只票在内的整体服务” → **合规**（服务推广）

---

#### 核心违规三要素（需同时满足）
1. **对象具体化**：明确提及或强烈暗示某一具体买入标的。  
2. **时机紧迫化**：如“明日出击”“尾盘统一建仓”“必买/必跟”等。  
3. **权限商品化（关键）**：付费被定义为**获取一次具体操作**的交换。  
   - **豁免**：若强调的是**解锁/享受/办理服务**（即服务权益交付），即使提及具体信号，仍视为**合规**。

---

#### 典型违规（单次机会售卖）
- “【共振擒龙1号】明日盘中只有少量买入时间，帮你申请最低价**办理跟上**。”
- “尾盘直接给**代码+买卖区间**，**现在办理好就发你**。”（强调拿代码）
- “统一建仓了，能**解锁跟上这一次**吗？”（解锁指本次操作）

---

#### 明确合规（不视为违规）
- **服务解锁类话术（允许诱饵）**：最终落脚为解锁/享受服务、体验课、权限办理。  
- **互动询问类**：询问是否解锁老师带队/服务。  
- **服务模式说明**：描述服务包含代码与区间。  
- **策略名作为产品展示**：引导加入特训营/战队获取。  
- **持续性内容描述**：如“每日模型精选案例”。  
- **同款模型/信号证明**：用于证明服务稳定性与能力。

---

#### 强制执行逻辑
1. 扫描**文本末尾引导动作**。  
2. 若为**解锁/享受/办理服务** → **一律合规**。  
3. 仅当引导动作为**为获取这一次具体代码/操作而付费** → **违规**。

**判定心法**
- 强调 **Unlock Service** → 合规  
- 强调 **Buy Code（单次）** → 违规
,"""
            
            """### 15. 虚假宣传案例精选及人工推票视为违规！！
**核心逻辑：**
此规则专门用于打击**用已下线的"老版本服务模式"忽悠客户**的行为。
**现状事实：** "案例精选"栏目对新客户已隐藏，现改为"股池"模式；**不再提供**老师二次复筛、**不再提供**微信推送提醒、**不再提供**明确买卖区间、**不再固定**每日"一主一创/每日两只"。
**判定关键：** 凡是向客户承诺**"不用自己选（老师帮你筛）"**、**"固定推送数量/搭配（如一主一创）"**、**"微信直接发买卖点"**或**"引导去找案例精选栏目"**的，均为违规。

**具体违规情形（必须字面匹配以下"已下线"的特征）：**

**1. 承诺"老师人工二次复筛"（违背"客户自选"原则）：**
*   **违规点：** 谎称有老师在模型基础上再进行人工精选，让客户"不用费心"。
*   *违规示例*："每天内部模型选股+**老师人工二次精选**"
*   *违规示例*："由**投研老师**结合市场热点**优中选优**给到您"
*   *违规示例*："**不用您去费心选股了**！只需按照提示操作"
*   *违规示例*："虽然没有案例精选了，但**老师还是会帮你单独挑出来**"（虚假承诺）

**2. 承诺具体的"推送数量与板块搭配"（违背"股池"原则）：**
*   **违规点：** 使用老版本的固定搭配话术，强调数量和板块的确定性。
*   *违规示例*："给到您**1到2支票**，**一只主板，一只创业板**"
*   *违规示例*："**每次两只**，搭配一个科创板或创业板"
*   *违规示例*："**一天推送四只**，根据行情来定"
*   *违规示例*："**一次只提示1-2支**，建议做完一只再做下一只"

**3. 承诺"微信推送"与"具体买卖指导"（违背"无提示"原则）：**
*   **违规点：** 承诺将代码和价格直接推送到微信，或承诺给具体的买卖区间。
*   *违规示例*："老师每天**微信上给您推送**，有具体的**买卖区间提示**"
*   *违规示例*："直接给您代码，**给到明确的【买入区间】和【卖出区间】**"
*   *违规示例*："**微信推送**，短线操作不墨迹"
*   *违规示例*："**微信人工盯盘或提示指导操作**，有问必答"（注：若语境是承诺通过微信发股票代码和买卖点，则违规）

**4. 引导寻找已下线的入口：**
*   *违规示例*："登录好之后，**首页上方有个【案例精选】**"
*   *违规示例*："您去看那个**案例精选栏目**"

**绝对合规内容（以下描述符合"新版本"现状，一律不违规）：**

**1. 提及"股池"与"自主查看"：**
*   *合规示例*："加入后您可以去**内部股池**查看。"
*   *合规示例*："我们提供模型选股结果，需要**您自己去池子里选**。"
*   *合规示例*："您可以参考我们的**选股模型**，自己把握机会。"

**2. 提及"无人工干预/无推送"的客观描述（实话实说）：**
*   *合规示例*："现在都是模型自动选股，**没有老师人为干预了**。"
*   *合规示例*："需要您登录软件自己看，**微信上不推票了**。"
*   *合规示例*："现在不分主板创业板了，都在池子里。"

**3. 仅展示历史战绩（不承诺未来服务模式）：**
*   *合规示例*："之前案例精选选出的【航天电子】涨得很好。"（仅陈述历史选股能力，未承诺现在还给具体的票，合规）。

**最终判断逻辑（精准打击）：**
1.  **第一步：抓特征词。**
    *   有没有提到 **"一主一创"**、**"一只主板一只创业板"**、**"每天两只/四只"**？ -> **有则直接违规**（这是最明显的老版本特征）。
2.  **第二步：看服务承诺。**
    *   有没有说 **"老师二次精选"**、**"不用自己选"**？ -> **有则违规**。
    *   有没有说 **"微信推送代码"**、**"给买卖区间"**？ -> **有则违规**。
    *   有没有引导去找 **"案例精选"**？ -> **有则违规**。
3.  **第三步：放行合规。**
    *   如果是让客户 **"去股池看"**、**"模型选股"**、**"自己选"**、**"无人工干预"** -> **合规**。"""
            ,

            """### 16. ### 冒用沈杨老师名义判定规则（修订版｜DeepSeek 友好）

**违规定义**
2.0 产品中的具体股票或策略**并非由沈杨老师本人直接提供**。  
在营销或服务沟通中，**将给票/选股/带队/通知等行为归因到“沈杨老师本人”**，视为**冒用个人名义宣传**，判定为违规。

---

#### 核心判定逻辑
- **身份归因错误即违规**：  
  2.0 产品的投研与给票来源于**投研团队其他老师**，不得描述为沈杨老师“本人亲自参与具体操作”。

---

#### 违规判定条件（满足任意一项即违规）
- 出现以下或同义表述**：
  - “沈杨老师**亲选**”
  - “沈杨老师**亲自给票**”
  - “沈杨老师**亲自带队**”
  - “沈杨老师**亲自通知 / 推送**”
  - “沈杨老师**亲自全程陪伴买卖**”
- 将**具体股票/策略**（如共振股、真龙、擒龙等）  
  明确归因为“**沈杨老师本人**亲自挑选 / 下发 / 提醒买卖”。

---

#### 绝对合规表述（以下一律合规）
- 使用**团队归因**：
  - “沈老师**投研团队**”
  - “沈老师**团队的老师**”
  - “**投研团队**给到的票 / 策略”
- 可以描述为：
  - “老师团队带队 / 陪伴 / 服务”
- **禁止点**：不得将“亲自给票 / 亲选 / 亲自通知”等行为，落到**沈杨老师个人**身上。

---

#### 最终判决要点
- 出现“**沈杨老师 + 亲选 / 亲自**”，
  → **违规（冒用沈杨老师个人名义）**
- 仅出现“**沈老师团队 / 投研团**”，未将给票行为归因到沈杨老师本人  
  → **合规**
。
"""
            ,

            """### 17. 收受客户礼品

**违规定义**
员工或服务方在与客户沟通中，**出现收受、索要或暗示收受**客户提供的礼品、红包或请客招待，均视为违规。

---

#### 核心判定逻辑
- **关键在于“收礼方向”**：  
  只有当礼品/红包/请客的**受益对象明确指向员工或服务方本人**时，才构成违规。
- **必须结合语境判断**，禁止脱离语境仅凭关键词命中。

---

#### 关键词与语境识别规则（必须同时满足）
仅当以下关键词**处于“客户 → 员工/服务方送礼，或员工引导/暗示客户送礼”语境中**，才进入违规判断：

礼物、红包、赠送、收受、寄给您、  
（给我）寄个东西、一点心意、寄点特产、  
一点小意思、请我吃饭、你请客、  
到你城市你请客、赚钱了请我吃饭。

---

#### 具体违规情形（满足任意一项即违规）
- 员工**明确表示要收或可以收**客户礼物/红包：
  - “给我发个红包”
  - “红包就不用了 / 给我来个红包”
  - “礼物寄给我就行”
- 员工**将请客/招待作为回报或交换**：
  - “赚钱了请我吃饭”
  - “我去你城市玩你请客”
  - “到时候你请我吃顿饭”
- 员工**暗示客户向自己表达心意或寄送物品**：
  - “给我寄点特产”
  - “一点心意就行”
  - “寄个东西给我”

---

#### 绝对合规内容（以下一律不违规）
- **公司或员工向客户赠送**礼品/红包/福利：
  - “我们给您送个礼品”
  - “公司活动赠送红包”
- **客户主动表达送礼/请客意向，员工明确拒绝且未引导继续**：
  - “谢谢心意，不用”
  - “这个不能收”
- **纯粹的节日祝福或客套寒暄**，未指向任何收受行为。

---

#### 最终判决要点
- 出现关键词，且**收礼对象明确为员工/服务方本人**  
  → **违规（收受客户礼品）**
- 关键词仅用于**赠送客户 / 公司福利 / 员工明确拒绝**  
  → **合规**
**。
""",
            """### 18. 夸大宣传策略重仓操作视为违规



**核心逻辑：**
禁止将策略/服务描述为“重仓操作”“敢上仓位/重仓参与”“一旦开仓就不是小打小闹”等夸大性表述，暗示客户应对该策略或机构票进行重仓投入，从而夸大策略份量、诱导客户大仓位跟投。

**关键词与语境识别：**
- 直接/强相关表述：一旦开仓就不是5%、10%小打小闹；对机构跟投策略足够有信心才敢上仓位/重仓参与；机构重仓王股、机构重仓股、带客户重仓参与、老师才会带客户重仓参与；私人定制学员开仓的机构重仓股；小仓位体验 vs 重仓参与 等对比性夸大。
- 结合语境：在宣传“机构调研/机构王股/私人定制”时，强调“只有调研复核后才能重仓”“不是小打小闹”“重仓才有底气”等，即属夸大宣传策略重仓操作。

**具体违规情形（满足任意一种即违规）：**
- 明确描述策略为“重仓操作”或“一旦开仓就不是小比例、小打小闹”：如“一旦开仓不是5%、10%小打小闹”“真正知根知底实战操作的还要看…机构王股”“私人定制学员一旦决定开仓的机构重仓股…不是5%10%小打小闹”。
- 以“敢上仓位/重仓参与”为卖点夸大策略：如“对机构跟投策略足够有信心，才敢上仓位/重仓参与”“只有私人定制调研复核后的机构重仓王股老师才会带客户重仓参与”。
- 将“小仓位”与“重仓”对比，突出重仓才配得上该策略：如“小仓位体验一下…如果想重仓的学员…”“作业股只是初选池、开胃前菜，小仓位体验；重仓的学员…调研复核…才能重仓参与”。

**绝对合规内容（以下一律不违规）：**
- 仅客观陈述仓位、比例（如“建议小仓位试水”“注意仓位控制”），未夸大“该策略适合/要求重仓”的。
- 未将策略与“重仓操作/敢上仓位”绑定的普通机构/调研话术。

**最终判决要点：**
- 关键词/语境 + 将策略或机构票与“重仓操作/上仓位/重仓参与/不是小打小闹”绑定 → **违规**（触发事件：夸大宣传策略重仓操作，仅 3.0 生效）。
- 仅提及“重仓”“仓位”但未用于夸大策略或诱导大仓位跟投 → 结合全文判定，谨慎判违规。
""",
        ]
        # 注意：您需要将完整的18条规则内容都放到上面的列表中

    def _keyword_match_rules(self, text: str) -> List[Tuple[int, float]]:
        """基于关键词匹配规则（备用检索方法）"""
        if not isinstance(text, str):
            text = self._normalize_input_text(text)
        text_lower = (text or "").lower()
        matches = []
        
        for rule_id, keywords in self.rule_keywords.items():
            score = 0
            matched_keywords = []
            
            for keyword in keywords:
                if keyword in text_lower:
                    score += 1
                    matched_keywords.append(keyword)
            
            if score > 0:
                matches.append((rule_id, score, matched_keywords))
        
        # 按分数排序
        matches.sort(key=lambda x: x[1], reverse=True)
        return matches

    def predict(self, text: str, product_type=None) -> Dict[str, Any]:
        """预测违规情况 - 基于你给出代码的预测逻辑（18 个事件保留，仅过滤虚假宣传/对投研）

        product_type: 产品类型。仅影响四个事件的生效范围：
        - "虚假宣传案例精选及人工推票" 仅在 product_type 为 1.0 时触发；
        - "冒用沈杨老师名义" 仅在 product_type 为 2.0 时触发；
        - "对投研调研活动夸大宣传"、"夸大宣传策略重仓操作" 仅在 product_type 为 3.0 时触发；
        - 其他事件与未传 product_type 时均为全量检测。
        """
        try:
            text = self._normalize_input_text(text)
            # 1. 调用 LLM 获取原始响应（禁用 callbacks 避免控制台打印检索结果等中间步骤）
            raw_response = self.chain.invoke(text, config={"callbacks": []})
            if raw_response is None:
                raw_response = ""
            raw_response = str(raw_response).strip()
            
            # 2. 基础解析变量初始化
            lines = [line.strip() for line in raw_response.split('\n') if line.strip()]
            violation = False
            triggered_event_str = "无"
            reason_raw = "未能解析模型响应"
            
            # 3. 逐行提取基础信息
            try:
                for line in lines:
                    if line.startswith('是否违规：'):
                        violation = "是" in line.split('：', 1)[-1]
                    elif line.startswith('触发事件：'):
                        triggered_event_str = line.split('：', 1)[-1].strip()
                    elif line.startswith('理由：'):
                        current_idx = lines.index(line)
                        reason_parts = [line.split('：', 1)[-1].strip()]
                        for next_line in lines[current_idx + 1:]:
                            if not any(next_line.startswith(x) for x in ['是否违规：', '触发事件：', '理由：']):
                                reason_parts.append(next_line)
                            else:
                                break
                        reason_raw = ' '.join(reason_parts)
                        break
            except Exception as e:
                reason_raw = f"解析关键行错误: {str(e)}"
            
            # 4. 拆分多个事件对应的理由
            event_reasons = {}
            if violation and triggered_event_str != "无":
                pattern = r"\[(.*?)\][:：]\s*(.*?)(?=;|；|$|\[)"
                matches = re.findall(pattern, reason_raw)
                if matches:
                    for evt_name, specific_reason in matches:
                        clean_name = evt_name.strip()
                        clean_reason = specific_reason.strip().rstrip(';').rstrip('；')
                        event_reasons[clean_name] = clean_reason
                else:
                    events = [e.strip() for e in triggered_event_str.split(',') if e.strip()]
                    for e in events:
                        event_reasons[e] = reason_raw

            # 5. 【product_type 过滤】虚假宣传(1.0)、冒用沈杨老师名义(2.0)、对投研/夸大策略重仓(3.0) 按产品类型过滤
            original_violation = violation
            original_triggered_event_str = triggered_event_str
            original_reason_raw = reason_raw
            original_event_reasons = event_reasons.copy()
            
            pt = product_type
            if pt is not None:
                if pt in (1, "1", "1.0"):
                    pt = "1.0"
                elif pt in (2, "2", "2.0"):
                    pt = "2.0"
                elif pt in (3, "3", "3.0"):
                    pt = "3.0"
                else:
                    pt = None
            
            if pt is not None and violation and triggered_event_str != "无":
                normalized = re.sub(r'[，、;；\s]+', ',', triggered_event_str)
                events = [e.strip() for e in normalized.split(',') if e.strip()]
                filtered_events = []
                for e in events:
                    if "虚假宣传案例精选及人工推票" in e and pt != "1.0":
                        continue
                    if "对投研调研活动夸大宣传" in e and pt != "3.0":
                        continue
                    if "冒用沈杨老师名义" in e and pt != "2.0":
                        continue
                    if "夸大宣传策略重仓操作" in e and pt != "3.0":
                        continue
                    filtered_events.append(e)
                filtered_events = list(dict.fromkeys(filtered_events))
                filtered_event_reasons = {}
                for evt_name, evt_reason in event_reasons.items():
                    should_keep = True
                    if "虚假宣传案例精选及人工推票" in evt_name and pt != "1.0":
                        should_keep = False
                    elif "对投研调研活动夸大宣传" in evt_name and pt != "3.0":
                        should_keep = False
                    elif "冒用沈杨老师名义" in evt_name and pt != "2.0":
                        should_keep = False
                    elif "夸大宣传策略重仓操作" in evt_name and pt != "3.0":
                        should_keep = False
                    if should_keep:
                        filtered_event_reasons[evt_name] = evt_reason
                triggered_event_str = ", ".join(filtered_events) if filtered_events else "无"
                violation = bool(filtered_events)
                if filtered_event_reasons:
                    new_reason_parts = [f"[{evt_name}]:{filtered_event_reasons[evt_name]}" for evt_name in filtered_events if evt_name in filtered_event_reasons]
                    reason_raw = "；".join(new_reason_parts)
                else:
                    reason_raw = "所有事件均根据产品类型过滤"
                event_reasons = filtered_event_reasons
                if not filtered_events:
                    violation = False
                    triggered_event_str = "无"
                    reason_raw = "所有表述均为合规描述"
            
            return {
                "raw_response": raw_response,
                "violation": violation,
                "triggered_event": triggered_event_str,
                "reason": reason_raw,
                "event_reasons": event_reasons,
                # 调试信息，可选
                "_debug": {
                    "original_violation": original_violation,
                    "original_triggered_event": original_triggered_event_str,
                    "original_reason": original_reason_raw,
                    "product_type": product_type,
                    "normalized_product_type": pt
                } if product_type is not None else None
            }
            
        except Exception as e:
            return {
                "raw_response": f"系统错误: {str(e)}",
                "violation": False,
                "triggered_event": "系统错误",
                "reason": str(e),
                "event_reasons": {}
            }


    def debug_retrieval(self, text: str) -> Dict[str, Any]:
        """调试检索过程：候选规则 ID、最终送入的完整规则列表。"""
        candidate_ids = self._get_candidate_rule_ids(text)
        full_rule_docs = self._retrieve_rules_full(text)
        keyword_matches = self._keyword_match_rules(text)
        return {
            "input": text,
            "candidate_rule_ids": candidate_ids,
            "candidate_rule_names": [self._get_rule_name_by_id(rid) for rid in candidate_ids],
            "keyword_matched_rules": [
                {
                    "rule_id": rule_id,
                    "rule_name": self._get_rule_name_by_id(rule_id),
                    "score": score,
                    "matched_keywords": matched_keywords
                }
                for rule_id, score, matched_keywords in keyword_matches[:5]
            ],
            "final_full_rules_ordered": [doc.metadata.get("rule_name", "未知") for doc in full_rule_docs],
            "final_count": len(full_rule_docs),
            "max_rules": self._max_rules,
        }


